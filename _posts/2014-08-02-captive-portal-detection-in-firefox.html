---
layout: post
title: Captive Portal detection in Firefox
date: '2014-08-02T03:39:00.001+03:00'
author: Valentin Gosu
tags:
- work
- captive portal
- firefox
- mozilla
modified_time: '2014-08-04T03:54:19.756+03:00'
blogger_id: tag:blogger.com,1999:blog-5128745106054389773.post-5867380708278748123
blogger_orig_url: http://binary-choice.blogspot.com/2014/08/captive-portal-detection-in-firefox.html
---

<div style="text-align: justify;">I haven't posted something on the blog in a while, so I thought I'd post something about my current work at Mozilla.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">I'm currently working on better captive portal detection in Firefox. You might correctly point out that there is no such detection at the moment. The feature does exist, but it's only enabled on Firefox OS. My job going forward will be to port this functionality over to Firefox, and to implement several enhancements.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">My first step was to gather all of the bugs and relevant info into a <a href="https://wiki.mozilla.org/Necko/CaptivePortal">wiki</a> page. The good news is that most of the groundwork is already there. The <a href="https://github.com/vtsatskin/FX-Captive-Portals-Design/blob/master/design/spec.md">design</a> for this feature has already been done (incidentally, by another Valentin working at Mozilla), and my job is to implement the capabilities that Necko needs to provide to other components.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">In order to test captive portal, I needed to set up one for myself - working at my local McDonald's is not an option :) Fortunately, this feature is part of the <a href="http://tomato.groov.pl/?page_id=81">Tomato</a> firmware which is also <a href="http://tomato.groov.pl/download/K26RT-N/build5x-121-EN/Asus%20RT-Nxx/">available</a> for my Asus N10U router. Yay!</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Next up, making captive portal detection available to desktop Firefox. The feature is implemented in <a href="http://dxr.mozilla.org/mozilla-central/source/toolkit/components/captivedetect/captivedetect.js">captivedetect.js</a>. The basic idea is that it tries to load a page from a predefined URL, and check the response against an expected value. If the values differ, or if we get a redirect, the odds are that we are inside a captive portal.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">On FirefoxOS the captive portal detection is used in the NetworkManager, which is a Gonk service which isn't going to be of much use on desktop. So I just stuck a captive portal request inside nsIOService, to see if it works. After finding and fixing a couple of <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1046848">typos</a> in captivedetect.js (How can you not love JavaScript for this?), it turns out that this works pretty well. I was able to observe notifications whenever the browser got a captive portal page and when the user logged in to that page, and was able to access any page on the web. So really <br />good news.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Going forward, I need to figure out how the captive portal fits with the rest of Necko, what I need for the UI, how do we handle secure connections, and many other issues. Also, Tomato doesn't seem to hijack secure connections, as other captive portals do, but I'm going to figure this out when I get to it. </div><div style="text-align: justify;"><br /></div><div style="text-align: justify;"><br /></div>